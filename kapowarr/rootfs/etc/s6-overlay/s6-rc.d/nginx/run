#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# s6-rc.d/nginx/run â€” nginx service run script
#
# s6-overlay starts nginx after the kapowarr service supervision has started.
# This script waits for the backend application to be ready before starting
# nginx, so the proxy does not return 502 errors during startup.
# ==============================================================================

# Redirect stderr to stdout
exec 2>&1

bashio::log.info "Starting nginx ingress proxy..."

# ---------------------------------------------------------------------------
# Wait for the backend application to be ready
# ---------------------------------------------------------------------------
readonly backend_host="localhost"
readonly backend_port="${APP_PORT:-5656}"
readonly wait_timeout=300

bashio::log.info "Waiting for kapowarr backend on ${backend_host}:${backend_port} (timeout: ${wait_timeout}s)..."

if ! bashio::net.wait_for "${backend_port}" "${backend_host}" "${wait_timeout}"; then
    bashio::log.error "kapowarr backend did not become ready within ${wait_timeout}s"
    bashio::log.error "Check the kapowarr service logs for startup errors"
    exit 1
fi

bashio::log.info "kapowarr backend is ready on ${backend_host}:${backend_port}"

# ---------------------------------------------------------------------------
# Start nginx in the foreground
# ---------------------------------------------------------------------------
bashio::log.info "nginx starting in foreground mode"
exec nginx
