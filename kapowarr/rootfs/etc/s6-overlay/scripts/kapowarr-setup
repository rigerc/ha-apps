#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# kapowarr-setup â€” Kapowarr environment setup
#
# Reads add-on options, prepares directories, and exports environment variables
# that the Kapowarr service will consume.
# ==============================================================================

set -e

# Source the shared logging library from HA framework
# shellcheck source=/usr/local/lib/ha-framework/ha-log.sh
source /usr/local/lib/ha-framework/ha-log.sh

# Source environment and directory helpers
# shellcheck source=/usr/local/lib/ha-framework/ha-env.sh
source /usr/local/lib/ha-framework/ha-env.sh
# shellcheck source=/usr/local/lib/ha-framework/ha-dirs.sh
source /usr/local/lib/ha-framework/ha-dirs.sh

# Initialise short-form logging helpers
ha::log::init "setup"

log_info "Setting up Kapowarr..."

# ---------------------------------------------------------------------------
# Read and export add-on options to s6 container environment
# ---------------------------------------------------------------------------
ha::env::log_level "log_level" "info" "LOG_LEVEL"
ha::env::timezone "timezone" "UTC"

# ---------------------------------------------------------------------------
# Prepare persistent data directories
# ---------------------------------------------------------------------------
ha::log::section "Directory setup"

ha::dirs::create_subdirs "/config" "data" "logs"
ha::dirs::ensure "/share/kapowarr"

log_info "Kapowarr setup complete"
