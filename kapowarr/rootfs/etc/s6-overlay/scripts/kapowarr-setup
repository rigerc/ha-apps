#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# kapowarr-setup â€” Kapowarr environment setup
#
# Reads add-on options, prepares directories, and exports environment variables
# that the Kapowarr service will consume.
# ==============================================================================

set -e

bashio::log.info "Setting up Kapowarr..."

# ---------------------------------------------------------------------------
# Read and export add-on options to s6 container environment
# ---------------------------------------------------------------------------
log_level="$(bashio::config 'log_level' 'info')"
bashio::log.level "${log_level}"
printf '%s' "${log_level}" > /var/run/s6/container_environment/APP_LOG_LEVEL

timezone="$(bashio::config 'timezone' 'UTC')"
printf '%s' "${timezone}" > /var/run/s6/container_environment/TZ

# Cache the ingress entry path so downstream services (kapowarr/run) don't
# need to make a redundant Supervisor API call
ingress_entry="$(bashio::addon.ingress_entry)"
printf '%s' "${ingress_entry}" > /var/run/s6/container_environment/APP_INGRESS_ENTRY

# ---------------------------------------------------------------------------
# Prepare persistent data directories
# ---------------------------------------------------------------------------
bashio::log.info "--- Directory setup ---"

mkdir -p /config/data /config/logs
mkdir -p /share/kapowarr

bashio::log.info "Kapowarr setup complete"
