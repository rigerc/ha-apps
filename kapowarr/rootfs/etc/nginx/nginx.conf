# ==============================================================================
# nginx.conf — Main nginx configuration for kapowarr Home Assistant add-on
#
# nginx runs as a supervised service under s6-overlay.
# The key requirement is "daemon off;" so s6 can manage the process lifecycle.
# ==============================================================================

# REQUIRED: run in the foreground so s6-overlay can supervise the process.
daemon off;

# Run as root (standard for HA add-ons — the container is already isolated)
user root;

# PID file location
pid /var/run/nginx.pid;

# One worker process is sufficient for a reverse proxy with modest load.
# CUSTOMIZE: increase to auto (= number of CPU cores) for high-throughput apps.
worker_processes 1;

# Enables JIT compilation for PCRE regular expressions — small performance win.
pcre_jit on;

# Write nginx error log to stdout.  s6-overlay captures stdout and routes it
# to the HA add-on log panel.  Setting level to "error" suppresses noise while
# surfacing real problems.
# CUSTOMIZE: change to "warn" or "notice" to see more nginx internals.
error_log /proc/1/fd/1 error;

# Maximum number of simultaneous connections per worker
events {
    worker_connections 512;
}

http {
    # MIME type map (required for correct Content-Type headers)
    include /etc/nginx/includes/mime.types;

    # Log format: timestamp, status, forwarded-for, remote-addr, request, user-agent
    # Write access log to stdout so it appears in the HA add-on log panel.
    # CUSTOMIZE: change to "off" to disable access logging (reduces noise).
    log_format hassio '[$time_local] $status '
                        '$http_x_forwarded_for ($remote_addr) '
                        '"$request" ($http_user_agent)';
    access_log /proc/1/fd/1 hassio;

    # Basic proxy settings
    client_max_body_size    0;          # no body size limit (apps may upload large files)
    default_type            application/octet-stream;
    keepalive_timeout       65;
    sendfile                on;
    server_tokens           off;        # do not expose nginx version in headers
    tcp_nodelay             on;
    tcp_nopush              on;

    # Compression — reduces bandwidth for text responses
    gzip                    on;
    gzip_disable            "msie6";
    gzip_vary               on;
    gzip_proxied            any;
    gzip_comp_level         6;
    gzip_types
        text/plain text/css text/xml text/javascript
        application/json application/javascript
        application/xml+rss application/rss+xml
        font/truetype font/opentype
        application/vnd.ms-fontobject;

    # WebSocket upgrade mapping.
    # proxy_set_header Connection $connection_upgrade; (set in proxy_params.conf)
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # DNS resolver — required when using variables in proxy_pass.
    # The Docker/HA default DNS is 127.0.0.11.
    include /etc/nginx/includes/resolver.conf;

    # Include all server blocks from the servers/ directory.
    include /etc/nginx/servers/*.conf;
}
