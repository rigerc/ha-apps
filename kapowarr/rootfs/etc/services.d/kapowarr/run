#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# services.d/kapowarr/run â€” Kapowarr service run script
#
# s6-overlay v3 calls this script to START the Kapowarr application service.
# The script MUST run the application in the FOREGROUND.
# ==============================================================================

# Redirect stderr to stdout
exec 2>&1

# Source the shared logging library
# shellcheck source=/usr/local/lib/ha-log.sh
source /usr/local/lib/ha-log.sh

ha::log::init "kapowarr"

log_info "Starting Kapowarr..."

# ---------------------------------------------------------------------------
# Read configuration
# ---------------------------------------------------------------------------
declare log_level
log_level="$(bashio::config 'log_level' 'info')"
log_info "Log level: ${log_level}"

# ---------------------------------------------------------------------------
# Set runtime environment variables
# ---------------------------------------------------------------------------
export TZ="${TZ:-UTC}"

# Get the port from environment or default to 5656
declare app_port
app_port="${APP_PORT:-5656}"

log_info "Kapowarr will listen on 0.0.0.0:${app_port}"

# ---------------------------------------------------------------------------
# Change to the application directory
# ---------------------------------------------------------------------------
cd /app || bashio::exit.nok "Could not change to /app directory"

# ---------------------------------------------------------------------------
# Configure log level in database
# Kapowarr stores log level as an integer in the config table.
# Map string levels to Python logging integers.
# ---------------------------------------------------------------------------
declare log_level_int
case "${log_level}" in
    trace)  log_level_int=5 ;;
    debug)  log_level_int=10 ;;
    info)   log_level_int=20 ;;
    warning) log_level_int=30 ;;
    error)  log_level_int=40 ;;
    *)      log_level_int=20 ;;
esac

declare db_file="/config/data/Kapowarr.db"

# Update log level if database exists
if [[ -f "${db_file}" ]]; then
    sqlite3 "${db_file}" "UPDATE config SET value = ${log_level_int} WHERE key = 'log_level';" 2>/dev/null || true
    log_debug "Updated log_level in database to ${log_level} (${log_level_int})"
fi

# ---------------------------------------------------------------------------
# Start Kapowarr with database folder for persistent storage
# Start in background so we can update the log level after DB initialization
# ---------------------------------------------------------------------------
python3 /app/Kapowarr.py -d /config/data &
kapowarr_pid=$!

# Wait for Kapowarr to initialize the database (first run)
# After it's up, update the log level and re-foreground the process
sleep 3

if [[ -f "${db_file}" ]]; then
    sqlite3 "${db_file}" "UPDATE config SET value = ${log_level_int} WHERE key = 'log_level';" 2>/dev/null || true
    log_debug "Verified log_level in database: ${log_level} (${log_level_int})"
fi

# Re-foreground the process by waiting for it
# This replaces the current shell with Kapowarr for proper signal handling
exec wait $kapowarr_pid
