#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# nginx-setup — nginx ingress configuration
#
# Reads the ingress IP address and port from the HA supervisor API and renders
# the nginx server block from a Go template using tempio.
#
# Depends on: APP_NAME-setup
# ==============================================================================

set -e

# Set bashio's log level for this service
# Read from container environment (set by APP_NAME-setup) so nginx uses
# the same log level as the main application.
bashio::log.level "${APP_LOG_LEVEL:-info}"

bashio::log.info "Configuring nginx ingress..."

# ---------------------------------------------------------------------------
# Obtain ingress coordinates from the HA supervisor
# ---------------------------------------------------------------------------
declare ingress_interface
declare ingress_port
declare app_port

ingress_interface="$(bashio::addon.ip_address)"
ingress_port="$(bashio::addon.ingress_port)"
app_port="${APP_PORT:-APP_PORT}"

bashio::log.debug "ingress_interface = ${ingress_interface}"
bashio::log.debug "ingress_port      = ${ingress_port}"
bashio::log.debug "app_port          = ${app_port}"

# ---------------------------------------------------------------------------
# Render the nginx server block from the Go template using tempio.
# ---------------------------------------------------------------------------
bashio::log.info "Rendering /etc/nginx/servers/ingress.conf via tempio..."

bashio::var.json \
    ingress_interface "${ingress_interface}" \
    ingress_port      "^${ingress_port}" \
    app_port          "^${app_port}" \
    | tempio \
        -template /etc/nginx/templates/ingress.gtpl \
        -out /etc/nginx/servers/ingress.conf

bashio::log.info "Ingress listening on ${ingress_interface}:${ingress_port} -> 127.0.0.1:${app_port}"

# ---------------------------------------------------------------------------
# Validate the nginx configuration before the nginx service starts
# ---------------------------------------------------------------------------
if ! nginx -t >/dev/null 2>&1; then
    bashio::log.error "nginx configuration test failed — check /etc/nginx/servers/ingress.conf"
    nginx -t 2>&1 || true
    exit 1
fi

bashio::log.info "nginx configuration is valid"
bashio::log.info "nginx ingress setup complete"
