#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# APP_NAME-setup â€” Application environment setup
#
# Reads add-on options, prepares directories, and exports environment variables
# that the application service (s6-rc.d/APP_NAME/run) will consume.
#
# Runs ONCE during container initialisation, before any services start.
# Depends on: banner
#
# CUSTOMIZE: Adapt this script to the configuration requirements of the
#            application you are wrapping.
# ==============================================================================

set -e

bashio::log.info "Setting up APP_NAME..."

# ---------------------------------------------------------------------------
# Read add-on options
# CUSTOMIZE: add or remove bashio::config calls to match your config.yaml options
# ---------------------------------------------------------------------------
declare log_level
declare timezone

log_level="$(bashio::config 'log_level' 'info')"
timezone="$(bashio::config 'timezone' 'UTC')"

# Set bashio's log level for this script
bashio::log.level "${log_level}"

bashio::log.debug "log_level = ${log_level}"
bashio::log.debug "timezone  = ${timezone}"

# ---------------------------------------------------------------------------
# Persist environment variables for service scripts
#
# s6-overlay v3 reads /var/run/s6/container_environment/* and makes those
# variables available via "with-contenv" (the shebang in service run scripts).
#
# Use printf to write values to /var/run/s6/container_environment/<VAR_NAME>
# to persist them for service scripts.
# ---------------------------------------------------------------------------

# Timezone
printf '%s' "${timezone}" > /var/run/s6/container_environment/TZ
bashio::log.debug "TZ persisted: ${timezone}"

# Application log level for the app itself (not bashio)
# Persist to container environment so nginx-setup and run scripts can read it.
# Each service script must call bashio::log.level to set bashio's own logging.
printf '%s' "${log_level}" > /var/run/s6/container_environment/APP_LOG_LEVEL

# CUSTOMIZE: export additional environment variables here, for example:
# printf '%s' "$(bashio::config 'username')" > /var/run/s6/container_environment/APP_USERNAME
# printf '%s' "$(bashio::config 'password')" > /var/run/s6/container_environment/APP_PASSWORD

# ---------------------------------------------------------------------------
# Prepare persistent data directories
# CUSTOMIZE: create any directories the application needs to exist at startup
# ---------------------------------------------------------------------------
bashio::log.info "--- Directory setup ---"

# /config is the addon_config mount (persistent, survives restarts and updates)
# mkdir -p creates the directory (and its parents) if it does not exist
mkdir -p /config

# Create application-specific subdirectories inside /config
# CUSTOMIZE: adjust these paths to match what your application expects
mkdir -p /config/data /config/logs

bashio::log.debug "Data directories ready"

# /share is the shared storage mount
# CUSTOMIZE: uncomment if the app needs to write to /share
# mkdir -p /share/APP_NAME

# ---------------------------------------------------------------------------
# Ingress: export the base URL so the app can construct correct URLs
# ---------------------------------------------------------------------------
if bashio::addon.ingress; then
    declare ingress_entry
    ingress_entry="$(bashio::addon.ingress_entry)"
    printf '%s' "${ingress_entry}" > /var/run/s6/container_environment/INGRESS_ENTRY
    bashio::log.info "Ingress base URL: ${ingress_entry}"
fi

bashio::log.info "APP_NAME setup complete"
