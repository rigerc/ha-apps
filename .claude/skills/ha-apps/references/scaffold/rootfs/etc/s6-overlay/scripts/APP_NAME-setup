#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# APP_NAME-setup â€” Application environment setup
#
# Reads add-on options, prepares directories, and exports environment variables
# that the application service (s6-rc.d/APP_NAME/run) will consume.
#
# Runs ONCE during container initialisation, before any services start.
# Depends on: banner
#
# CUSTOMIZE: Adapt this script to the configuration requirements of the
#            application you are wrapping.
# ==============================================================================

set -e

# Source the full HA framework (loads all libraries including ha-log.sh)
# shellcheck source=/usr/local/lib/ha-framework/ha-framework.sh
source /usr/local/lib/ha-framework/ha-framework.sh

# Initialise short-form logging helpers (log_info, log_debug, log_warn, log_error)
ha::log::init "setup"

log_info "Setting up APP_NAME..."

# ---------------------------------------------------------------------------
# Read add-on options
# CUSTOMIZE: add or remove bashio::config calls to match your config.yaml options
# ---------------------------------------------------------------------------
declare log_level
declare timezone

log_level="$(bashio::config 'log_level' 'info')"
timezone="$(bashio::config 'timezone' 'UTC')"

log_debug "log_level = ${log_level}"
log_debug "timezone  = ${timezone}"

# ---------------------------------------------------------------------------
# Persist environment variables for service scripts
#
# s6-overlay v3 reads /var/run/s6/container_environment/* and makes those
# variables available via "with-contenv" (the shebang in service run scripts).
#
# Use ha::env::export for generic variables, ha::env::log_level for log level,
# ha::env::timezone for TZ, and ha::env::ingress for the ingress entry URL.
# ---------------------------------------------------------------------------

# Timezone
ha::env::timezone "${timezone}"
log_debug "TZ persisted: ${timezone}"

# Application log level
ha::env::log_level "${log_level}"

# CUSTOMIZE: export additional environment variables here, for example:
# ha::env::export "APP_USERNAME" "$(bashio::config 'username')"
# ha::env::export "APP_PASSWORD" "$(bashio::config 'password')"

# ---------------------------------------------------------------------------
# Prepare persistent data directories
# CUSTOMIZE: create any directories the application needs to exist at startup
# ---------------------------------------------------------------------------
ha::log::section "Directory setup"

# /config is the addon_config mount (persistent, survives restarts and updates)
# ha::dirs::ensure creates the directory (and its parents) if it does not exist
ha::dirs::ensure "/config"

# Create application-specific subdirectories inside /config
# CUSTOMIZE: adjust these paths to match what your application expects
ha::dirs::create_subdirs "/config" "data" "logs"

log_debug "Data directories ready"

# /share is the shared storage mount
# CUSTOMIZE: uncomment if the app needs to write to /share
# ha::dirs::ensure "/share/APP_NAME"

# ---------------------------------------------------------------------------
# Ingress: export the base URL so the app can construct correct URLs
# ---------------------------------------------------------------------------
if bashio::addon.ingress; then
    declare ingress_entry
    ingress_entry="$(bashio::addon.ingress_entry)"
    ha::env::ingress "${ingress_entry}"
    log_info "Ingress base URL: ${ingress_entry}"
fi

log_info "APP_NAME setup complete"
