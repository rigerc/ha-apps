## Home Assistant Add-ons Repository

Monorepo for HA add-ons: romm, profilarr, huntarr, cleanuparr. Each add-on wraps existing Docker images with HA-specific config and ingress support.

## Commands

```bash
# Generate manifest.json from add-on configs
.github/scripts/manifest.sh

# Generate manifest + all README files (requires gomplate)
.github/scripts/manifest.sh -g

# Generate manifest + update dependabot.yml
.github/scripts/manifest.sh -d

# Generate manifest + update release-please.yaml paths
.github/scripts/manifest.sh -r

# Generate manifest + update ci.yaml paths
.github/scripts/manifest.sh -c

# Update all configs (manifest, dependabot, release-please, ci, READMEs)
.github/scripts/manifest.sh -g -d -r -c

# Test local add-on build (from add-on directory)
docker build --build-arg BUILD_FROM=base-image:tag -t test-addon .

# Validate workflows
actionlint .github/workflows/*.yaml
```

## Repository Structure

```
romm/              # ROMM add-on
profilarr/         # Profilarr add-on
huntarr/           # Huntarr add-on
cleanuparr/        # Cleanuparr add-on
├── config.yaml    # HA add-on metadata (name, version, arch, options)
├── build.yaml     # Build config (labels.project = upstream GitHub URL)
├── Dockerfile     # Multi-stage: upstream image AS base, then HA wrapper
├── CHANGELOG.md   # Auto-generated by release-please
├── README.md      # Auto-generated by manifest.sh from templates
├── DOCS.md        # User-facing docs (manually maintained)
└── rootfs/        # Filesystem overlay (run.sh entrypoint, config scripts)

.github/
├── scripts/manifest.sh         # Manifest generator (reads config.yaml, Dockerfile)
├── templates/                  # Gomplate templates for READMEs
├── workflows/                  # CI/CD automation
└── release-please-config.json  # Version management config

manifest.json      # Auto-generated add-on registry (used by README templates)
```

## Critical: Auto-Generated Files

**NEVER manually edit these files** - they are regenerated by automation:
- `manifest.json` - Generated by manifest.sh, tracks all add-ons + upstream versions
- `*/README.md` - Generated from .github/templates via gomplate
- `*/CHANGELOG.md` - Maintained by release-please

**When to regenerate:**
- After changing config.yaml or Dockerfile: run `manifest.sh`
- After adding new add-on: run `manifest.sh -d -r` to update path filters

## Adding New Add-ons

1. Create directory with required files (config.yaml, build.yaml, Dockerfile, rootfs/)
2. Run `.github/scripts/manifest.sh -d -r -c` to update dependabot.yml, release-please.yaml, and ci.yaml
3. Add package config to `.github/release-please-config.json`

## manifest.sh Behavior

Scans for config.yaml files, extracts:
- Add-on metadata (slug, version, name, description, arch)
- Docker image from first `FROM ... AS` line in Dockerfile
- Project URL from build.yaml labels.project
- Upstream version via GitHub Releases API (prefers this over registry APIs)
- Version comparison (is_up_to_date: true/false/null)

## Key Gotchas

- **[skip ci] required**: When committing manifest.json/README.md, use `[skip ci]` to prevent workflow loops
- **Path filters matter**: CI workflows use specific paths (romm/**, profilarr/**, etc.) - add new add-ons to filters
- **Dockerfile convention**: First `FROM ... AS` line determines upstream image tracking
- **build.yaml.labels.project**: Must be GitHub URL for accurate version checking via Releases API
- **Release-please version sync**: Updates both config.yaml and build.yaml automatically on release
- **Multi-arch builds**: Add both aarch64 and amd64 to config.yaml arch array

## Workflow Links

- **GitHub Workflows** - See `.claude/rules/github-workflows.md` for CI/CD flow
- **When Editing Workflows** - See `.claude/rules/workflow-editing.md` for action versions and patterns
