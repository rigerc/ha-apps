## Home Assistant Add-ons Repository

Monorepo for HA add-ons: romm, profilarr, huntarr, cleanuparr. Each add-on wraps existing Docker images with HA-specific config and ingress support.

## Commands

```bash
# Flags: -g (READMEs), -d (dependabot.yml), -r (release-please.yaml), -c (ci.yaml)
# Update manifest only:
.github/scripts/manifest.sh
# Update all:
.github/scripts/manifest.sh -g -d -r -c

# Test local add-on build (from add-on directory)
docker build --build-arg BUILD_FROM=base-image:tag -t test-addon .

# Validate workflows
actionlint .github/workflows/*.yaml
```

## Repository Structure

```
{addon}/            # romm, profilarr, huntarr, cleanuparr
├── config.yaml    # HA add-on metadata (name, version, arch, options)
├── build.yaml     # Build config (labels.project = upstream GitHub URL)
├── Dockerfile     # Multi-stage: upstream image AS base, then HA wrapper
├── DOCS.md        # User-facing docs (manually maintained)
└── rootfs/        # Filesystem overlay (run.sh entrypoint, config scripts)

common/            # Shared framework for HA add-ons
├── README.md      # Framework documentation and usage guide
├── version.txt    # Framework version for cache busting
├── lib/           # Shared library modules
│   ├── ha-log.sh       # Logging utilities
│   ├── ha-env.sh       # Environment variable export
│   ├── ha-config.sh    # Configuration helpers
│   ├── ha-dirs.sh      # Directory and symlink management
│   ├── ha-secret.sh    # Secret generation
│   └── ha-validate.sh   # Validation functions
└── scripts/        # Installation scripts
    └── install-framework.sh  # Downloads and installs framework in container

.github/
├── scripts/manifest.sh         # Manifest generator (reads config.yaml, Dockerfile)
├── templates/                  # Gomplate templates for READMEs
├── workflows/                  # CI/CD automation
└── release-please-config.json  # Version management config

manifest.json      # Auto-generated add-on registry (used by README templates)
```

## Common Framework

The `common/` directory provides shared helper scripts and utilities for all add-ons. During Docker build, each add-on downloads the framework from GitHub and installs it at `/usr/local/lib/ha-framework/`.

### Usage in Add-on Dockerfile

```dockerfile
# After copying rootfs, download and install the framework
RUN apk add --no-cache curl && \
    curl -fsSL "https://raw.githubusercontent.com/rigerc/ha-apps/main/common/scripts/install-framework.sh" -o /tmp/install.sh && \
    chmod +x /tmp/install.sh && \
    /tmp/install.sh --github main && \
    rm -f /tmp/install.sh
```

### Usage in Init/Service Scripts

Source individual libraries from the framework:

```bash
# Source logging library
# shellcheck source=/usr/local/lib/ha-framework/ha-log.sh
source /usr/local/lib/ha-framework/ha-log.sh

# Source environment helpers
source /usr/local/lib/ha-framework/ha-env.sh

# Source configuration helpers
source /usr/local/lib/ha-framework/ha-config.sh
```

See `common/README.md` for complete library documentation.

## Critical: Auto-Generated Files

**NEVER manually edit these files** - they are regenerated by automation:
- `manifest.json` - Generated by manifest.sh, tracks all add-ons + upstream versions
- `*/README.md` - Generated from .github/templates via gomplate
- `*/CHANGELOG.md` - Maintained by release-please

Run `manifest.sh` after changing `config.yaml` or `Dockerfile`.

## Key Gotchas

- **Dockerfile convention**: First `FROM ... AS` line determines upstream image tracking
- **build.yaml.labels.project**: Must be GitHub URL for accurate version checking via Releases API
- **Multi-arch builds**: Add both aarch64 and amd64 to config.yaml arch array

## Adding New Add-ons

1. Create directory: `config.yaml`, `build.yaml`, `Dockerfile`, `rootfs/`
2. Run `.github/scripts/manifest.sh -d -r -c`
3. Add package to `.github/release-please-config.json`

## Workflow Links

- **GitHub Workflows** - See `.claude/rules/github-workflows.md` for CI/CD flow
- **When Editing Workflows** - See `.claude/rules/workflow-editing.md` for action versions and patterns
