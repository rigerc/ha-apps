---
name: Lint

env:
  MONITORED_FILES: "build.yaml,config.yaml,Dockerfile,rootfs,apparmor.txt"

# yamllint disable-line rule:truthy
on:
  workflow_call:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  find:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    name: ‚è≥ Find addons
    outputs:
      addons: ${{ steps.addons.outputs.addons_list }}
    steps:
      - name: ‚§µÔ∏è Check out the repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Find changed add-ons
        id: changed_addons
        uses: ./.github/actions/find-changed-addons
        if: github.event_name != 'workflow_dispatch'
        with:
          base_ref: ${{ github.base_ref || github.ref_name }}
          monitored_files: ${{ env.MONITORED_FILES }}
          ignore: ".gemini"

      - name: üîç Find all add-ons
        id: find_all
        uses: ./.github/actions/find-addons
        if: github.event_name == 'workflow_dispatch'
        with:
          ignore: ".gemini"

      - name: üìã Build addons list
        id: addons
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "addons=${{ steps.find_all.outputs.addons_list }}" >> "$GITHUB_OUTPUT"
          else
            # Convert comma-separated to JSON array
            addons="${{ steps.changed_addons.outputs.addons }}"
            if [[ -n "$addons" ]]; then
              IFS=',' read -ra ADDR <<< "$addons"
              json="["
              for i in "${!ADDR[@]}"; do
                addon="${ADDR[$i]}"
                json+="\"${addon}\""
                if [[ $i -lt $((${#ADDR[@]} - 1)) ]]; then
                  json+=","
                fi
              done
              json+="]"
              echo "addons=$json" >> "$GITHUB_OUTPUT"
            else
              echo "addons=[]" >> "$GITHUB_OUTPUT"
            fi
          fi

  lint:
    name: üîç Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ‚§µÔ∏è Check out the repository
        uses: actions/checkout@v4

      - name: üîç Shellcheck
        uses: ludeeus/action-shellcheck@2.0.0
        env:
          SHELLCHECK_OPTS: -s bash
        with:
          ignore_paths: .claude docs scripts

      - name: üîç Markdown Lint
        uses: actionshub/markdownlint@v3.1.4
        with:
          filesToIgnoreRegex: "(.*(README|CHANGELOG|DOCS).md|^\\.claude/.*|^docs/.*|^scripts/.*)"

      - name: üîç JSON Lint
        run: |
          find . -name "*.json" \
            -not -path "./.claude/*" \
            -not -path "./docs/*" \
            -not -path "./scripts/*" \
            -exec cat {} \; | jq '.'

      - name: üîç YAML Lint
        run: |
          yq eval '... comments=""' --output-format=yaml \
            $(find . -name "*.yaml" -o -name "*.yml" \
              -not -path "./.git/*" \
              -not -path "./.claude/*" \
              -not -path "./node_modules/*" \
              -not -path "*/.*") > /dev/null

  lint-addons:
    name: üîç Add-on Lint (${{ matrix.addon }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: find
    if: needs.find.outputs.addons != '[]'
    strategy:
      fail-fast: false
      matrix:
        addon: ${{ fromJson(needs.find.outputs.addons) }}
    steps:
      - name: ‚§µÔ∏è Check out the repository
        uses: actions/checkout@v4

      - name: üöÄ Add-on Linter
        uses: frenck/action-addon-linter@v2
        with:
          path: "./${{ matrix.addon }}"

      - name: üê≥ Dockerfile Lint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: "./${{ matrix.addon }}/Dockerfile"

      - name: üìã Verify build.yaml project key
        run: |
          BUILD_FILE="${{ matrix.addon }}/build.yaml"
          if [[ ! -f "$BUILD_FILE" ]]; then
            echo "‚ùå Error: build.yaml not found in ${{ matrix.addon }}"
            exit 1
          fi

          PROJECT_VALUE=$(yq eval '.labels.project // ""' "$BUILD_FILE")

          if [[ -z "$PROJECT_VALUE" || "$PROJECT_VALUE" == "null" ]]; then
            echo "‚ùå Error: build.yaml in ${{ matrix.addon }} is missing 'labels.project' key"
            exit 1
          fi

          echo "‚úÖ build.yaml has project key with value: $PROJECT_VALUE"
