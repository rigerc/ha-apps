---
name: Lint

env:
  MONITORED_FILES: "build.yaml,config.yaml,Dockerfile,rootfs,apparmor.txt"

# yamllint disable-line rule:truthy
on:
  workflow_call:
  workflow_dispatch:

jobs:
  find:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    name: â³ Find addons
    outputs:
      addons: ${{ steps.addons.outputs.addons_list }}
      addons_csv: ${{ steps.addons.outputs.addons }}
    steps:
      - name: â¤µï¸ Check out the repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Find changed add-ons
        id: changed_addons
        uses: ./.github/actions/find-changed-addons
        if: github.event_name != 'workflow_dispatch'
        with:
          base_ref: ${{ github.base_ref || github.ref_name }}
          monitored_files: ${{ env.MONITORED_FILES }}
          ignore: ".gemini"

      - name: ğŸ” Find all add-ons
        id: find_all
        uses: ./.github/actions/find-addons
        if: github.event_name == 'workflow_dispatch'
        with:
          ignore: ".gemini"

      - name: ğŸ“‹ Build addons list
        id: addons
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "addons=${{ steps.find_all.outputs.addons }}" >> "$GITHUB_OUTPUT"
            echo "addons_list=${{ steps.find_all.outputs.addons_list }}" >> "$GITHUB_OUTPUT"
          else
            # Output both CSV and JSON formats
            addons="${{ steps.changed_addons.outputs.addons }}"
            echo "addons=$addons" >> "$GITHUB_OUTPUT"
            if [[ -n "$addons" ]]; then
              result=$(echo "$addons" | jq -R 'split(",") | map(select(length > 0))')
              {
                echo "addons_list<<EOF"
                echo "$result"
                echo "EOF"
              } >> "$GITHUB_OUTPUT"
            else
              echo "addons_list=[]" >> "$GITHUB_OUTPUT"
            fi
          fi

  lint:
    name: ğŸ” Lint
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: find
    if: needs.find.outputs.addons != '[]'
    steps:
      - name: â¤µï¸ Check out the repository
        uses: actions/checkout@v4

      - name: ğŸ”„ Setup addon list
        id: setup
        run: |
          addons='${{ needs.find.outputs.addons_csv }}'
          echo "addons=$addons" >> "$GITHUB_OUTPUT"
          echo "â„¹ï¸ Linting addons: $addons"

      - name: ğŸ” Shellcheck
        run: |
          for addon in ${{ steps.setup.outputs.addons }}; do
            echo "ğŸ” Shellchecking $addon..."
            find "./$addon" -name "*.sh" -exec shellcheck -s bash {} +
          done

      - name: ğŸ” Markdown Lint
        run: |
          for addon in ${{ steps.setup.outputs.addons }}; do
            echo "ğŸ” Markdown linting $addon..."
            find "./$addon" -name "*.md" \
              ! -name "README.md" \
              ! -name "CHANGELOG.md" \
              ! -name "DOCS.md" \
              -exec npx markdownlint {} +
          done

      - name: ğŸ” JSON Lint
        run: |
          for addon in ${{ steps.setup.outputs.addons }}; do
            echo "ğŸ” JSON linting $addon..."
            find "./$addon" -name "*.json" -exec cat {} \; | jq '.'
          done

      - name: ğŸ” YAML Lint
        run: |
          for addon in ${{ steps.setup.outputs.addons }}; do
            echo "ğŸ” YAML linting $addon..."
            find "./$addon" \( -name "*.yaml" -o -name "*.yml" \) \
              -exec yq eval '... comments=""' --output-format=yaml {} + > /dev/null
          done

      - name: ğŸš€ Add-on Linter
        run: |
          for addon in ${{ steps.setup.outputs.addons }}; do
            echo "ğŸš€ Add-on linting $addon..."
            docker run --rm -v "$(pwd)/$addon:/data:ro" \
              ghcr.io/home-assistant/amd64-addon-linter:latest
          done

      - name: ğŸ³ Dockerfile Lint
        run: |
          for addon in ${{ steps.setup.outputs.addons }}; do
            echo "ğŸ³ Hadolinting $addon/Dockerfile..."
            hadolint "./$addon/Dockerfile"
          done

      - name: ğŸ“‹ Verify build.yaml project key
        run: |
          for addon in ${{ steps.setup.outputs.addons }}; do
            BUILD_FILE="$addon/build.yaml"
            if [[ ! -f "$BUILD_FILE" ]]; then
              echo "âŒ Error: build.yaml not found in $addon"
              exit 1
            fi

            PROJECT_VALUE=$(yq eval '.labels.project // ""' "$BUILD_FILE")

            if [[ -z "$PROJECT_VALUE" || "$PROJECT_VALUE" == "null" ]]; then
              echo "âŒ Error: build.yaml in $addon is missing 'labels.project' key"
              exit 1
            fi

            echo "âœ… build.yaml has project key with value: $PROJECT_VALUE"
          done
