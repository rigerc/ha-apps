---
name: Lint

env:
  MONITORED_FILES: "build.yaml,config.yaml,Dockerfile,rootfs,apparmor.txt"

# yamllint disable-line rule:truthy
on:
  workflow_call:
  workflow_dispatch:

jobs:
  find:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    name: â³ Find addons
    outputs:
      addons: ${{ steps.addons.outputs.addons_list }}
      addons_csv: ${{ steps.addons.outputs.addons }}
      common_changed: ${{ steps.check_common.outputs.any_changed || steps.check_common_dispatch.outputs.common_changed || 'false' }}
    steps:
      - name: â¤µï¸ Check out the repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ” Find changed add-ons
        id: changed_addons
        uses: ./.github/actions/find-changed-addons
        if: github.event_name != 'workflow_dispatch'
        with:
          base_ref: ${{ github.base_ref || github.ref_name }}
          monitored_files: ${{ env.MONITORED_FILES }}
          ignore: ".gemini"

      - name: ğŸ” Find all add-ons
        id: find_all
        uses: ./.github/actions/find-addons
        if: github.event_name == 'workflow_dispatch'
        with:
          ignore: ".gemini"

      - name: ğŸ” Check if common framework changed
        id: check_common
        if: github.event_name != 'workflow_dispatch'
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
        with:
          files: common/**

      - name: ğŸ” Check if common framework has shell scripts (workflow_dispatch)
        id: check_common_dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          # For manual dispatch, check if any .sh files exist in common/
          if find ./common -name "*.sh" -type f | grep -q .; then
            echo "common_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "common_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸ“‹ Build addons list
        id: addons
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            addons_value="${{ steps.find_all.outputs.addons }}"
            # The action outputs invalid JSON like [cleanuparr, huntarr, profilarr, romm]
            # We need to convert it to valid JSON using jq
            raw_list="${{ steps.find_all.outputs.addons_list }}"
            # Remove outer brackets, split by comma, and create proper JSON
            addons_list_value=$(echo "$raw_list" | sed 's/^\[//;s/\]$//' | tr ',' '\n' | jq -R 'split("\n") | map(select(length > 0))')
            echo "addons=$addons_value" >> "$GITHUB_OUTPUT"
            {
              echo "addons_list<<EOF"
              echo "$addons_list_value"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            # Output both CSV and JSON formats
            addons="${{ steps.changed_addons.outputs.addons }}"
            echo "addons=$addons" >> "$GITHUB_OUTPUT"
            if [[ -n "$addons" ]]; then
              result=$(echo "$addons" | jq -R 'split(",") | map(select(length > 0))')
              {
                echo "addons_list<<EOF"
                echo "$result"
                echo "EOF"
              } >> "$GITHUB_OUTPUT"
            else
              echo "addons_list=[]" >> "$GITHUB_OUTPUT"
            fi
          fi

  permissions:
    name: ğŸ”’ Rootfs permissions
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: find
    if: needs.find.outputs.addons_csv != ''
    steps:
      - name: â¤µï¸ Check out the repository
        uses: actions/checkout@v6

      - name: ğŸ”’ Check rootfs file permissions
        run: |
          failed=false
          for addon in $(echo "${{ needs.find.outputs.addons_csv }}" | tr ',' ' '); do
            rootfs="./$addon/rootfs"
            if [[ ! -d "$rootfs" ]]; then
              echo "â„¹ï¸ No rootfs directory in $addon, skipping"
              continue
            fi
            echo "ğŸ”’ Checking executable permissions in $rootfs..."
            while IFS= read -r -d '' file; do
              if [[ ! -x "$file" ]]; then
                echo "âŒ Not executable: $file"
                failed=true
              fi
            done < <(find "$rootfs" -type f -print0)
          done
          if [[ "$failed" == "true" ]]; then
            echo "âŒ Some rootfs files are not executable. Run the fix-permissions workflow or chmod +x them."
            exit 1
          fi
          echo "âœ… All rootfs files are executable"

  shellcheck:
    name: ğŸ” Shellcheck
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: find
    if: needs.find.outputs.addons_csv != '' || needs.find.outputs.common_changed == 'true'
    steps:
      - name: â¤µï¸ Check out the repository
        uses: actions/checkout@v6

      - name: ğŸ” Shellcheck
        run: |
          # Shellcheck add-ons
          for addon in $(echo "${{ needs.find.outputs.addons_csv }}" | tr ',' ' '); do
            echo "ğŸ” Shellchecking $addon..."
            find "./$addon" -name "*.sh" -exec shellcheck -s bash {} +
          done

          # Shellcheck common framework if changed
          if [[ "${{ needs.find.outputs.common_changed }}" == "true" ]]; then
            echo "ğŸ” Shellchecking common..."
            find "./common" -name "*.sh" -exec shellcheck -s bash {} +
          fi

  markdown:
    name: ğŸ” Markdown Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: find
    if: needs.find.outputs.addons_csv != ''
    steps:
      - name: â¤µï¸ Check out the repository
        uses: actions/checkout@v6

      - name: ğŸ” Markdown Lint
        run: |
          for addon in $(echo "${{ needs.find.outputs.addons_csv }}" | tr ',' ' '); do
            echo "ğŸ” Markdown linting $addon..."
            find "./$addon" -name "*.md" \
              ! -name "README.md" \
              ! -name "CHANGELOG.md" \
              ! -name "DOCS.md" \
              -exec npx markdownlint {} +
          done

  json:
    name: ğŸ” JSON Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: find
    if: needs.find.outputs.addons_csv != ''
    steps:
      - name: â¤µï¸ Check out the repository
        uses: actions/checkout@v6

      - name: ğŸ” JSON Lint
        run: |
          for addon in $(echo "${{ needs.find.outputs.addons_csv }}" | tr ',' ' '); do
            echo "ğŸ” JSON linting $addon..."
            find "./$addon" -name "*.json" -exec cat {} \; | jq '.'
          done

  yaml:
    name: ğŸ” YAML Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: find
    if: needs.find.outputs.addons_csv != ''
    steps:
      - name: â¤µï¸ Check out the repository
        uses: actions/checkout@v6

      - name: ğŸ” YAML Lint
        run: |
          for addon in $(echo "${{ needs.find.outputs.addons_csv }}" | tr ',' ' '); do
            echo "ğŸ” YAML linting $addon..."
            find "./$addon" \( -name "*.yaml" -o -name "*.yml" \) \
              -exec yq eval '... comments=""' --output-format=yaml {} + > /dev/null
          done

  addon-linter:
    name: ğŸš€ Add-on Linter
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: find
    if: needs.find.outputs.addons_csv != ''
    strategy:
      fail-fast: false
      matrix:
        addon: ${{ fromJSON(needs.find.outputs.addons) }}
    steps:
      - name: â¤µï¸ Check out the repository
        uses: actions/checkout@v6

      - name: ğŸš€ Add-on Linter
        uses: frenck/action-addon-linter@v2
        with:
          path: "./${{ matrix.addon }}"

  dockerfile:
    name: ğŸ³ Dockerfile Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: find
    if: needs.find.outputs.addons_csv != ''
    strategy:
      fail-fast: false
      matrix:
        addon: ${{ fromJSON(needs.find.outputs.addons) }}
    steps:
      - name: â¤µï¸ Check out the repository
        uses: actions/checkout@v6

      - name: ğŸ³ Dockerfile Lint
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: "./${{ matrix.addon }}/Dockerfile"
          config: './.github/.hadolint.yaml'

  build-yaml:
    name: ğŸ“‹ Verify build.yaml
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: find
    if: needs.find.outputs.addons_csv != ''
    steps:
      - name: â¤µï¸ Check out the repository
        uses: actions/checkout@v6

      - name: ğŸ“‹ Verify build.yaml project key
        run: |
          for addon in $(echo "${{ needs.find.outputs.addons_csv }}" | tr ',' ' '); do
            BUILD_FILE="$addon/build.yaml"
            if [[ ! -f "$BUILD_FILE" ]]; then
              echo "âŒ Error: build.yaml not found in $addon"
              exit 1
            fi

            PROJECT_VALUE=$(yq eval '.labels.project // ""' "$BUILD_FILE")

            if [[ -z "$PROJECT_VALUE" || "$PROJECT_VALUE" == "null" ]]; then
              echo "âŒ Error: build.yaml in $addon is missing 'labels.project' key"
              exit 1
            fi

            echo "âœ… build.yaml has project key with value: $PROJECT_VALUE"
          done
