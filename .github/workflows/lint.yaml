---
name: Lint

env:
  MONITORED_FILES: "build.yaml,config.yaml,Dockerfile,rootfs,apparmor.txt"

# yamllint disable-line rule:truthy
on:
  workflow_call:
  workflow_dispatch:

jobs:
  find:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    name: ‚è≥ Find addons
    outputs:
      addons: ${{ steps.addons.outputs.addons_list }}
      addons_csv: ${{ steps.addons.outputs.addons }}
    steps:
      - name: ‚§µÔ∏è Check out the repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Find changed add-ons
        id: changed_addons
        uses: ./.github/actions/find-changed-addons
        if: github.event_name != 'workflow_dispatch'
        with:
          base_ref: ${{ github.base_ref || github.ref_name }}
          monitored_files: ${{ env.MONITORED_FILES }}
          ignore: ".gemini"

      - name: üîç Find all add-ons
        id: find_all
        uses: ./.github/actions/find-addons
        if: github.event_name == 'workflow_dispatch'
        with:
          ignore: ".gemini"

      - name: üìã Build addons list
        id: addons
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "addons=${{ steps.find_all.outputs.addons }}" >> "$GITHUB_OUTPUT"
            echo "addons_list=${{ steps.find_all.outputs.addons_list }}" >> "$GITHUB_OUTPUT"
          else
            # Output both CSV and JSON formats
            addons="${{ steps.changed_addons.outputs.addons }}"
            echo "addons=$addons" >> "$GITHUB_OUTPUT"
            if [[ -n "$addons" ]]; then
              result=$(echo "$addons" | jq -R 'split(",") | map(select(length > 0))')
              {
                echo "addons_list<<EOF"
                echo "$result"
                echo "EOF"
              } >> "$GITHUB_OUTPUT"
            else
              echo "addons_list=[]" >> "$GITHUB_OUTPUT"
            fi
          fi

  lint:
    name: üîç Lint
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: find
    if: needs.find.outputs.addons != '[]'
    steps:
      - name: ‚§µÔ∏è Check out the repository
        uses: actions/checkout@v4

      - name: üîÑ Setup addon list
        id: setup
        run: |
          addons='${{ needs.find.outputs.addons_csv }}'
          echo "addons=$addons" >> "$GITHUB_OUTPUT"
          echo "‚ÑπÔ∏è Linting addons: $addons"

      - name: üîç Shellcheck
        run: |
          for addon in ${{ steps.setup.outputs.addons }}; do
            echo "üîç Shellchecking $addon..."
            find "./$addon" -name "*.sh" -exec shellcheck -s bash {} +
          done

      - name: üîç Markdown Lint
        run: |
          for addon in ${{ steps.setup.outputs.addons }}; do
            echo "üîç Markdown linting $addon..."
            find "./$addon" -name "*.md" \
              ! -name "README.md" \
              ! -name "CHANGELOG.md" \
              ! -name "DOCS.md" \
              -exec npx markdownlint {} +
          done

      - name: üîç JSON Lint
        run: |
          for addon in ${{ steps.setup.outputs.addons }}; do
            echo "üîç JSON linting $addon..."
            find "./$addon" -name "*.json" -exec cat {} \; | jq '.'
          done

      - name: üîç YAML Lint
        run: |
          for addon in ${{ steps.setup.outputs.addons }}; do
            echo "üîç YAML linting $addon..."
            find "./$addon" \( -name "*.yaml" -o -name "*.yml" \) \
              -exec yq eval '... comments=""' --output-format=yaml {} + > /dev/null
          done

      - name: üöÄ Add-on Linter
        uses: frenck/action-addon-linter@v2
        with:
          path: "./${{ steps.setup.outputs.addons }}"

      - name: üê≥ Dockerfile Lint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: "./${{ steps.setup.outputs.addons }}/Dockerfile"

      - name: üìã Verify build.yaml project key
        run: |
          for addon in ${{ steps.setup.outputs.addons }}; do
            BUILD_FILE="$addon/build.yaml"
            if [[ ! -f "$BUILD_FILE" ]]; then
              echo "‚ùå Error: build.yaml not found in $addon"
              exit 1
            fi

            PROJECT_VALUE=$(yq eval '.labels.project // ""' "$BUILD_FILE")

            if [[ -z "$PROJECT_VALUE" || "$PROJECT_VALUE" == "null" ]]; then
              echo "‚ùå Error: build.yaml in $addon is missing 'labels.project' key"
              exit 1
            fi

            echo "‚úÖ build.yaml has project key with value: $PROJECT_VALUE"
          done
