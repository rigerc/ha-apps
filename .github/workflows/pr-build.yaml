---
name: PR Build

on:
  pull_request:
    types: [labeled, unlabeled, opened, synchronize, reopened]
    branches: main
  workflow_dispatch:

permissions:
  contents: read
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-labels:
    runs-on: ubuntu-latest
    name: üè∑Ô∏è Check labels
    timeout-minutes: 5
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      base_ref: ${{ steps.check.outputs.base_ref }}
    steps:
      - name: üîç Check for trigger labels
        id: check
        env:
          HAS_RELEASE: ${{ contains(github.event.pull_request.labels.*.name, 'release') }}
          HAS_DEPENDENCIES: ${{ contains(github.event.pull_request.labels.*.name, 'dependencies') }}
          HAS_DOCKER: ${{ contains(github.event.pull_request.labels.*.name, 'docker') }}
        run: |
          should_build=false
          if [[ "${HAS_RELEASE}" == "true" ]]; then
            should_build=true
          elif [[ "${HAS_DEPENDENCIES}" == "true" ]] && [[ "${HAS_DOCKER}" == "true" ]]; then
            should_build=true
          fi

          if [[ "${should_build}" == "true" ]]; then
            echo "‚úÖ Build labels found"
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            echo "base_ref=${{ github.event.pull_request.base.ref }}" >> "$GITHUB_OUTPUT"
          else
            echo "‚ÑπÔ∏è Required labels not found"
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            echo "base_ref=" >> "$GITHUB_OUTPUT"
          fi

  find-changed-addons:
    runs-on: ubuntu-latest
    name: ‚è≥ Find changed add-ons
    timeout-minutes: 10
    needs: check-labels
    if: needs.check-labels.outputs.should_build == 'true' && needs.check-labels.outputs.base_ref != ''
    outputs:
      addons: ${{ steps.find.outputs.addons }}
    steps:
      - name: ‚§µÔ∏è Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Find changed add-ons
        id: find
        uses: ./.github/actions/find-changed-addons
        with:
          base_ref: ${{ needs.check-labels.outputs.base_ref }}
          ignore: ".gemini"

  build:
    needs: [check-labels, find-changed-addons]
    if: needs.check-labels.outputs.should_build == 'true'
    uses: ./.github/workflows/builder.yaml
    with:
      addons: ${{ needs.find-changed-addons.outputs.addons }}
