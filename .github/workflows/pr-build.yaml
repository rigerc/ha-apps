---
name: PR Build

on:
  pull_request:
    types: [labeled, unlabeled, opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-labels:
    runs-on: ubuntu-latest
    name: üè∑Ô∏è Check labels
    timeout-minutes: 5
    outputs:
      build_release: ${{ steps.check.outputs.build_release }}
      build_deps: ${{ steps.check.outputs.build_deps }}
      addons: ${{ steps.check.outputs.addons }}
      base_ref: ${{ steps.check.outputs.base_ref }}
    steps:
      - name: üîç Check for trigger labels
        id: check
        env:
          LABELS_JSON: ${{ toJSON(github.event.pull_request.labels) }}
          HAS_RELEASE: ${{ contains(github.event.pull_request.labels.*.name, 'release') }}
          HAS_DEPENDENCIES: ${{ contains(github.event.pull_request.labels.*.name, 'dependencies') }}
          HAS_DOCKER: ${{ contains(github.event.pull_request.labels.*.name, 'docker') }}
        run: |
          # Extract addons from 'app:' labels using jq
          addons=()
          while IFS= read -r addon; do
            [[ -n "$addon" ]] && addons+=("$addon")
          done < <(echo "${LABELS_JSON}" | jq -r '.[] | select(.name | startswith("app:")) | .name | sub("^app:[[:space:]]*"; "")')

          {
            if [[ "${HAS_RELEASE}" == "true" ]] && [[ ${#addons[@]} -gt 0 ]]; then
              addons_csv=$(IFS=','; echo "${addons[*]}")
              echo "‚úÖ Release mode with app labels: ${addons_csv}"
              echo "build_release=true"
              echo "build_deps=false"
              echo "addons=${addons_csv}"
              echo "base_ref="
            elif [[ "${HAS_DEPENDENCIES}" == "true" ]] && [[ "${HAS_DOCKER}" == "true" ]]; then
              echo "‚úÖ Dependencies mode - will find changed addons"
              echo "build_release=false"
              echo "build_deps=true"
              echo "addons="
              echo "base_ref=${{ github.event.pull_request.base.ref }}"
            else
              echo "‚ÑπÔ∏è No matching label combinations"
              echo "build_release=false"
              echo "build_deps=false"
              echo "addons="
              echo "base_ref="
            fi
          } >> "$GITHUB_OUTPUT"

  find-changed-addons:
    runs-on: ubuntu-latest
    name: ‚è≥ Find changed add-ons
    timeout-minutes: 10
    needs: check-labels
    if: needs.check-labels.outputs.build_deps == 'true' && needs.check-labels.outputs.base_ref != ''
    outputs:
      addons: ${{ steps.find.outputs.addons }}
    steps:
      - name: üîç Find changed add-ons
        id: find
        uses: ./.github/actions/find-changed-addons
        with:
          base_ref: ${{ needs.check-labels.outputs.base_ref }}
          ignore: ".gemini"

  build:
    needs: [check-labels, find-changed-addons]
    if: needs.check-labels.outputs.build_release == 'true' || needs.check-labels.outputs.build_deps == 'true'
    uses: ./.github/workflows/builder.yaml
    with:
      addons: ${{ needs.check-labels.outputs.build_release == 'true' && needs.check-labels.outputs.addons || needs.find-changed-addons.outputs.addons }}
