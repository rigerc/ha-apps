name: Delete add-on releases and packages

on:
  workflow_dispatch:
    inputs:
      slug:
        description: "Add-on slug (e.g. kapowarr)"
        required: true
        type: string
      dry_run:
        description: "Dry run — log what would be deleted without making changes"
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  packages: write

jobs:
  delete-addon:
    name: "Delete ${{ inputs.slug }}"
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate slug and extract packages
        id: manifest
        env:
          SLUG: ${{ inputs.slug }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          ENTRY=$(jq -r ".[] | select(.slug == \"$SLUG\")" manifest.json)

          if [ -z "$ENTRY" ] || [ "$ENTRY" = "null" ]; then
            echo "::error::Slug '$SLUG' not found in manifest.json"
            echo "Available slugs:"
            jq -r '.[].slug' manifest.json
            exit 1
          fi

          PACKAGES=$(echo "$ENTRY" | jq -r '.packages | join(" ")')
          echo "packages=$PACKAGES" >> "$GITHUB_OUTPUT"
          echo "Found packages: $PACKAGES"

          {
            echo "## Delete add-on: \`$SLUG\`"
            echo ""
            if [ "$DRY_RUN" = "true" ]; then
              echo "> **Dry run** — no changes were made. Re-run with **dry_run = false** to perform deletions."
            else
              echo "> **Live run** — deletions performed."
            fi
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Delete releases and tags
        env:
          SLUG: ${{ inputs.slug }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "Fetching releases matching '${SLUG}-'..."

          TAGS=$(gh release list \
            --repo "${{ github.repository }}" \
            --json tagName \
            --limit 1000 \
            | jq -r --arg prefix "${SLUG}-" '.[] | select(.tagName | startswith($prefix)) | .tagName')

          COUNT=$(echo "$TAGS" | grep -c . || true)

          {
            echo "### Releases & tags (\`${SLUG}-*\`)"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          if [ -z "$TAGS" ]; then
            echo "No releases found matching '${SLUG}-'"
            echo "No releases found." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Found $COUNT release(s) matching '${SLUG}-'"
            {
              echo "| Tag | Status |"
              echo "|-----|--------|"
            } >> "$GITHUB_STEP_SUMMARY"

            while IFS= read -r TAG; do
              [ -z "$TAG" ] && continue
              if [ "$DRY_RUN" = "true" ]; then
                echo "[DRY RUN] Would delete release: $TAG"
                echo "| \`$TAG\` | Would delete |" >> "$GITHUB_STEP_SUMMARY"
              else
                echo "Deleting release: $TAG"
                gh release delete "$TAG" --cleanup-tag --yes \
                  --repo "${{ github.repository }}"
                echo "| \`$TAG\` | Deleted |" >> "$GITHUB_STEP_SUMMARY"
              fi
            done <<< "$TAGS"

            echo "" >> "$GITHUB_STEP_SUMMARY"
            if [ "$DRY_RUN" = "true" ]; then
              echo "_$COUNT release(s) would be deleted._" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "_$COUNT release(s) deleted._" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"

      - name: Delete GHCR packages
        env:
          PACKAGES: ${{ steps.manifest.outputs.packages }}
          DRY_RUN: ${{ inputs.dry_run }}
          OWNER: ${{ github.repository_owner }}
        run: |
          OWNER_TYPE=$(gh api "/users/$OWNER" --jq '.type')
          echo "Owner type: $OWNER_TYPE"

          if [ "$OWNER_TYPE" = "Organization" ]; then
            API_BASE="/orgs/$OWNER"
          else
            API_BASE="/users/$OWNER"
          fi

          {
            echo "### GHCR packages"
            echo ""
            echo "| Package | Versions | Status |"
            echo "|---------|----------|--------|"
          } >> "$GITHUB_STEP_SUMMARY"

          # shellcheck disable=SC2153
          for PKG in $PACKAGES; do
            ENDPOINT="${API_BASE}/packages/container/${PKG}"

            if [ "$DRY_RUN" = "true" ]; then
              VERSION_COUNT=$(gh api "${ENDPOINT}/versions" --paginate \
                --jq '. | length' 2>/dev/null | awk '{s+=$1} END {print s}' || echo "unknown")
              echo "[DRY RUN] Would delete package: $PKG ($VERSION_COUNT versions)"
              echo "| \`$PKG\` | $VERSION_COUNT | Would delete |" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "Deleting package: $PKG"
              if gh api -X DELETE "$ENDPOINT" 2>/dev/null; then
                echo "Deleted package: $PKG"
                echo "| \`$PKG\` | — | Deleted |" >> "$GITHUB_STEP_SUMMARY"
              else
                echo "::warning::Package '$PKG' not found or could not be deleted — skipping"
                echo "| \`$PKG\` | — | Not found (skipped) |" >> "$GITHUB_STEP_SUMMARY"
              fi
            fi
          done
