name: Review dependency changes

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - 'dependabot/docker/*'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  request-coderabbit-review:
    name: Request coderabbit Code Review
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.actor == 'dependabot[bot]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Get PR details for manual trigger
        id: pr_details
        if: github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ secrets.PAT || github.token }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          # Fetch PR details using gh CLI
          PR_DATA=$(gh pr view "$PR_NUMBER" --json headRefName,number,author)

          BRANCH_NAME=$(echo "$PR_DATA" | jq -r '.headRefName')
          AUTHOR=$(echo "$PR_DATA" | jq -r '.author.login')

          {
            echo "branch_name=$BRANCH_NAME"
            echo "pr_number=$PR_NUMBER"
            echo "author=$AUTHOR"
          } >> "$GITHUB_OUTPUT"

          # Checkout the PR branch
          gh pr checkout "$PR_NUMBER"

      - name: Fetch Dependabot metadata
        id: metadata
        if: github.event_name != 'workflow_dispatch'
        uses: dependabot/fetch-metadata@v2
        continue-on-error: true

      - name: Extract addon slug and metadata
        id: addon
        env:
          BRANCH_NAME: ${{ github.event_name == 'workflow_dispatch' && steps.pr_details.outputs.branch_name || github.head_ref }}
          IMAGE_NAME: ${{ steps.metadata.outputs.dependency-names }}
          GH_TOKEN: ${{ secrets.PAT || github.token }}
          PR_NUMBER: ${{ github.event_name == 'workflow_dispatch' && inputs.pr_number || github.event.pull_request.number }}
        run: |
          # Validate branch is a Dependabot Docker update
          if [[ ! "$BRANCH_NAME" =~ ^dependabot/docker/ ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "::warning::Branch '$BRANCH_NAME' is not a Dependabot Docker update branch"
            exit 0
          fi

          # Extract addon slug from branch name
          # Format: dependabot/docker/{addon-slug}/{image-parts}/{version}
          ADDON_SLUG=$(echo "$BRANCH_NAME" | cut -d'/' -f3)
          echo "slug=$ADDON_SLUG" >> "$GITHUB_OUTPUT"

          # For manual triggers, extract image name and versions from PR diff
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Get PR diff to extract version changes
            PR_DIFF=$(gh pr diff "$PR_NUMBER")

            # Try to extract image name from manifest.json based on addon
            ADDON_CONFIG=$(jq -r ".[] | select(.slug==\"$ADDON_SLUG\")" manifest.json)
            if [ -n "$ADDON_CONFIG" ] && [ "$ADDON_CONFIG" != "null" ]; then
              DOCKER_IMAGE=$(echo "$ADDON_CONFIG" | jq -r '.docker_image // empty')
              if [ -n "$DOCKER_IMAGE" ]; then
                echo "image_name=$DOCKER_IMAGE" >> "$GITHUB_OUTPUT"
              fi
            fi

            # Parse versions from Dockerfile changes (look for FROM ... AS/as lines)
            # Example diff:
            # -FROM ghcr.io/rommapp/romm:1.0.0 AS base
            # +FROM ghcr.io/rommapp/romm:2.0.0 AS base
            OLD_FROM=$(echo "$PR_DIFF" | grep -iE "^-FROM .* [Aa][Ss]" | head -n1 | sed -E 's/.*[:/]([^:/ ]+) [Aa][Ss].*/\1/')
            NEW_FROM=$(echo "$PR_DIFF" | grep -iE "^\+FROM .* [Aa][Ss]" | head -n1 | sed -E 's/.*[:/]([^:/ ]+) [Aa][Ss].*/\1/')

            echo "old_version=$OLD_VERSION" >> "$GITHUB_OUTPUT"
            echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

            echo "Detected versions: $OLD_VERSION -> $NEW_VERSION"
          fi

          # Get project URL from manifest.json
          if [ ! -f manifest.json ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "::warning::manifest.json not found"
            exit 0
          fi

          PROJECT_URL=$(jq -r ".[] | select(.slug==\"$ADDON_SLUG\") | .project" manifest.json)

          if [ -z "$PROJECT_URL" ] || [ "$PROJECT_URL" = "null" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "::warning::Addon '$ADDON_SLUG' not found in manifest.json"
            exit 0
          fi

          # Validate GitHub URL
          if [[ ! "$PROJECT_URL" =~ ^https?://github\.com/ ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "::warning::Project URL is not a GitHub URL: $PROJECT_URL"
            exit 0
          fi

          echo "project_url=$PROJECT_URL" >> "$GITHUB_OUTPUT"

          # Extract owner/repo from GitHub URL
          REPO_PATH=$(echo "$PROJECT_URL" | sed -E 's|https?://github\.com/||' | sed 's|\.git$||')
          echo "repo_path=$REPO_PATH" >> "$GITHUB_OUTPUT"

      - name: Fetch upstream diff
        id: diff
        if: steps.addon.outputs.skip != 'true'
        env:
          OLD_VERSION: ${{ github.event_name == 'workflow_dispatch' && steps.addon.outputs.old_version || steps.metadata.outputs.previous-version }}
          NEW_VERSION: ${{ github.event_name == 'workflow_dispatch' && steps.addon.outputs.new_version || steps.metadata.outputs.new-version }}
          REPO_PATH: ${{ steps.addon.outputs.repo_path }}
        run: |
          if [ -z "$OLD_VERSION" ] || [ -z "$NEW_VERSION" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "::error::Missing version information (old: $OLD_VERSION, new: $NEW_VERSION)"
            exit 0
          fi

          # Build compare and diff URLs
          COMPARE_URL="https://github.com/${REPO_PATH}/compare/${OLD_VERSION}...${NEW_VERSION}"
          DIFF_URL="${COMPARE_URL}.diff"

          echo "compare_url=$COMPARE_URL" >> "$GITHUB_OUTPUT"

          # Fetch diff content
          echo "Fetching diff from: $DIFF_URL"

          DIFF_FILE=$(mktemp)
          if curl -sL "$DIFF_URL" -o "$DIFF_FILE"; then
            DIFF_SIZE=$(stat -f%z "$DIFF_FILE" 2>/dev/null || stat -c%s "$DIFF_FILE")

            # Truncate if larger than 50KB
            if [ "$DIFF_SIZE" -gt 51200 ]; then
              {
                echo "⚠️ Diff is large ($(numfmt --to=iec-i --suffix=B "$DIFF_SIZE")), truncating to first 50KB..."
                head -c 51200 "$DIFF_FILE"
                echo ""
                echo "..."
                echo ""
                echo "[Diff truncated - view full changes at $COMPARE_URL]"
              } > "${DIFF_FILE}.truncated"
              mv "${DIFF_FILE}.truncated" "$DIFF_FILE"
            fi

            # Check if diff is empty
            if [ ! -s "$DIFF_FILE" ]; then
              {
                echo "⚠️ No diff content available. The versions may not exist as tags/releases in the upstream repository."
                echo ""
                echo "Please check the compare URL manually: $COMPARE_URL"
              } > "$DIFF_FILE"
            fi
          else
            {
              echo "❌ Failed to fetch diff from upstream repository."
              echo ""
              echo "Please check the compare URL manually: $COMPARE_URL"
            } > "$DIFF_FILE"
          fi

          echo "diff_file=$DIFF_FILE" >> "$GITHUB_OUTPUT"

      - name: Post coderabbit review request comment
        if: steps.addon.outputs.skip != 'true' && steps.diff.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT || github.token }}
          ADDON_SLUG: ${{ steps.addon.outputs.slug }}
          IMAGE_NAME: ${{ github.event_name == 'workflow_dispatch' && steps.addon.outputs.image_name || steps.metadata.outputs.dependency-names }}
          OLD_VERSION: ${{ github.event_name == 'workflow_dispatch' && steps.addon.outputs.old_version || steps.metadata.outputs.previous-version }}
          NEW_VERSION: ${{ github.event_name == 'workflow_dispatch' && steps.addon.outputs.new_version || steps.metadata.outputs.new-version }}
          UPDATE_TYPE: ${{ steps.metadata.outputs.update-type || 'unknown' }}
          COMPARE_URL: ${{ steps.diff.outputs.compare_url }}
          DIFF_FILE: ${{ steps.diff.outputs.diff_file }}
          PR_NUMBER: ${{ github.event_name == 'workflow_dispatch' && inputs.pr_number || github.event.pull_request.number }}
        run: |
          # Create comment body using heredoc with variable substitution
          cat > comment.md << EOF
          @coderabbit

          Please review this Dependabot Docker image update for the **${ADDON_SLUG}** addon.

          ### Update Summary
          - **Addon**: ${ADDON_SLUG}
          - **Image**: ${IMAGE_NAME}
          - **Version Change**: ${OLD_VERSION} → ${NEW_VERSION}
          - **Update Type**: ${UPDATE_TYPE}

          ### Review Instructions
          1. Analyze the upstream changes in the diff below
          2. Check for breaking changes or deprecated features
          3. Verify compatibility with current addon configuration
          4. Review security implications of the update
          5. Assess impact on Home Assistant addon functionality

          ### Upstream Changes

          Full comparison: ${COMPARE_URL}

          <details>
          <summary>Upstream Diff (${OLD_VERSION}...${NEW_VERSION})</summary>

          \`\`\`diff
          $(cat "$DIFF_FILE")
          \`\`\`

          </details>

          ---
          *Automated request via \`dependabot-coderabbit-review\` workflow*
          EOF

          # Post comment
          gh pr comment "$PR_NUMBER" --body-file comment.md
        continue-on-error: true
